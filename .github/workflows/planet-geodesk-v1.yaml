name: Planet GeoDesk v1

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Planet GeoDesk v2"]
    types: [completed]
    branches: [main]

jobs:
  gol:
    runs-on: self-hosted

    outputs:
      tag: ${{ steps.date.outputs.tag }}

    steps:
      - name: Set date tag
        id: date
        uses: openplanetdata/actions/set-date-tag@main

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          distribution: zulu
          java-version: 25

      - name: Install GOL 1.x
        uses: openplanetdata/actions/install-gol@main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          version: 1

      - name: Download latest published PBF
        uses: openplanetdata/actions/download@main
        with:
          remote_path: osm/planet/pbf/planet-latest.osm.pbf

      - name: Rename downloaded PBF
        run: mv planet-latest.osm.pbf "planet-${{ steps.date.outputs.tag }}.osm.pbf"

      - name: Build GOL variant
        run: |
          g="planet-${{ steps.date.outputs.tag }}.osm.gol"
          p="planet-${{ steps.date.outputs.tag }}.osm.pbf"

          # Set temp directory to current working directory
          export TMPDIR="$PWD/.tmp"
          mkdir -p "$TMPDIR"

          export JAVA_TOOL_OPTIONS="-Xms96g -Xmx96g"

          echo "Starting build at $(date -u +%Y-%m-%d_%H:%M:%S)"
          echo "Using TMPDIR: $TMPDIR"
          echo "JVM options: $JAVA_TOOL_OPTIONS"

          time gol build --tag-duplicate-nodes=yes "$g" "$p"

          echo "Build finished at $(date -u +%Y-%m-%d_%H:%M:%S)"
          ls -alh "$g"

      - name: Create metadata
        id: create_meta
        uses: openplanetdata/actions/create-metadata@main
        with:
          deprecated: true
          deprecation_reason: Users should switch to GeoDesk v2 and associated files; support for v1 will be removed after 30/09/2026.
          file: planet-${{ steps.date.outputs.tag }}.osm.gol
          remote_filename: planet-latest.osm.gol
          remote_path: /osm/planet/gol
          remote_version: 1
          tags: |
            geodesk
            gol
            openstreetmap
            public

      - name: Upload to R2
        uses: openplanetdata/actions/upload@main
        env:
          RCLONE_CONFIG_DATA: ${{ secrets.RCLONE_CONFIG_DATA }}
        with:
          file: planet-${{ steps.date.outputs.tag }}.osm.gol
          remote_filename: planet-latest.osm.gol
          remote_path: /osm/planet/gol
          remote_version: 1

      - name: Cleanup downloaded files
        if: always()
        uses: openplanetdata/actions/cleanup-downloads@main

      - name: Cleanup generated files
        if: always()
        env:
          TAG: ${{ steps.date.outputs.tag }}
        run: |
          rm -f planet-*.osm.gol planet-*.osm.gol.{sha256,metadata}
          rm -rf .tmp
          find /tmp -name "tmp.*" -user "$USER" -delete 2>/dev/null || true
          # Remove old PBF files, keep today's for caching
          for f in planet-*.osm.pbf; do
            [ -f "$f" ] && [ "$f" != "planet-${TAG}.osm.pbf" ] && rm -f "$f" || true
          done
